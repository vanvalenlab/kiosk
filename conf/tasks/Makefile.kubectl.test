## Provision RBAC cluster role binding
kubectl/test/create/rbac:
	@echo " "
	@echo "Finalizing Kubernetes RBAC roles and bindings."
	@kubectl create clusterrolebinding add-on-cluster-admin --clusterrole=cluster-admin --serviceaccount=kube-system:default 2> /dev/null || \
		echo "Kubernetes RBAC binding is already under control. No changes made."
	@echo "Kubernetes RBAC roles creation and binding finished."
	@echo " "
	@echo " "

## Deploy ConfigMap with prometheus-redis-exporter script.
kubectl/test/create/prometheus-redis-exporter-script:
	-@kubectl create namespace monitoring 2>/dev/null || true
	$(TEST_HOME_DIR)/gomplate_linux-amd64-slim -f patches/redis-exporter-script.yaml | kubectl apply -f -

## Provision cluster autoscaler
kubectl/test/create/autoscaler:
	$(TEST_HOME_DIR)/gomplate_linux-amd64-slim -f addons/cluster-autoscaler.yaml | kubectl apply -f -

## Provision cluster autoscaler
kubectl/test/create/nvidia-drivers:
	$(TEST_HOME_DIR)/gomplate_linux-amd64-slim -f addons/nvidia-device-plugin.yaml | kubectl apply -f -

## Provision all extra resources with kubectl
kubectl/test/create/all: \
  kubectl/test/create/rbac \
  kubectl/test/create/autoscaler \
  kubectl/test/create/nvidia-drivers
	@echo "Kubectl provisioned"

## Display the cluster IP or URL
kubectl/test/display/ip: IP_VAR = $(shell sh -c "kubectl describe service --namespace=kube-system ingress-nginx-ingress-controller | grep 'LoadBalancer Ingress:' | sed 's/\([[:graph:]]\+[[:space:]]\+\)\+\([0-9.]\+\|[[:graph:]]\+amazon[[:graph:]]\+\)/\2/'")
kubectl/test/display/ip:
	@echo " "
	@echo " "
	@echo Cluster address: ${IP_VAR}
	@echo " "
	@echo " "
	@echo export CLUSTER_ADDRESS=${IP_VAR} > ./cluster_address

## Tear down prometheus-operator and it's CRDs
kubectl/test/destroy/prometheus/operator:
	@echo "Deleting prometheus-operator..."
	-@helm delete prometheus-operator --purge
	-@kubectl delete crd prometheuses.monitoring.coreos.com
	-@kubectl delete crd prometheusrules.monitoring.coreos.com
	-@kubectl delete crd servicemonitors.monitoring.coreos.com
	-@kubectl delete crd alertmanagers.monitoring.coreos.com
	-@kubectl delete crd podmonitors.monitoring.coreos.com

## Create horizontal pod autoscalers for all relevant deployments
kubectl/test/implement/autoscaling:
	@envsubst < patches/hpa.yaml  > patches/hpa_subbed.yaml
	@kubectl apply -f patches/hpa_subbed.yaml
	@$(TEST_HOME_DIR)/conf/kubens.sh deepcell
